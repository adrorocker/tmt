<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Making Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="layout" class="flex h-screen transition-transform duration-300">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed bg-gray-200 top-0 left-0 w-64 h-full transform transition-transform duration-300 -translate-x-full z-20">
            <div class="p-4 flex flex-col h-full">
                <!-- Logo -->
                <div class="flex items-center justify-center">
                    <span class="text-xl font-bold text-blue-500">Trail Making Test</span>
                </div>
                <!-- Main Menu -->
                <ul class="mt-4">
                    <li class="py-2"><button id="variant-a" class="hover:text-blue-500">Variant A</button></li>
                    <li class="py-2"><button id="variant-b" class="hover:text-blue-500">Variant B</button></li>
                    <li class="py-2"><button id="results-history" class="hover:text-blue-500">Results History</button></li>
                </ul>
                <div class="flex-grow"></div>
                <!-- Settings Section -->
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-600 mb-2">Settings</h3>
                    <button id="delete-all-history" class="hover:text-red-500 text-sm">Delete All History</button>
                    <button id="next-value-toggle" class="hover:text-red-500 text-sm">Show Next Value: On</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 transform transition-transform duration-300">
            <!-- Navbar -->
            <div class="navbar flex justify-between items-center p-4 z-50">
                <div class="flex items-center">
                    <button id="menu-toggle" class="btn btn-square btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <p id="timer-display" class="ml-4 text-blue-600 font-bold hidden">Time: 0 seconds</p>
                    <p id="trail-result" class="mt-4 text-green-600 font-bold hidden">Test completed successfully!</p>
                </div>
                <div class="flex items-center justify-end space-x-4">
                    <button id="reopen-modal" class="btn btn-secondary hidden">Reopen Last Results</button>
                    <button id="info-icon" class="text-blue-500 hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Page Content -->
            <div id="trail-test" class="p-4">
                <div id="info-popup" class="hidden absolute top-16 right-4 bg-white border border-gray-300 shadow-lg p-4 rounded w-64 z-10">
                    <p class="text-sm text-gray-700">Click the circles in the correct order as quickly as possible. Variant A uses numbers, and Variant B alternates between numbers and letters.</p>
                    <button id="close-popup" class="mt-2 text-blue-500 hover:text-blue-400">Close</button>
                </div>
                <div id="trail-container" class="relative w-full h-[calc(100vh-8rem)] mt-4">
                    <!-- Circles will be generated here -->
                    <p id="initial-description" class="text-center">
                        Welcome to the Trail Making Test! <br>
                        <span id="choose-variant-intro" class="text-blue-600 font-bold">Choose a variant to start from the menu.</span>
                    </p>
                </div>
            </div>

            <!-- Results History Modal -->
            <div id="results-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white p-6 rounded shadow-lg w-96">
                    <h2 class="text-xl font-bold mb-4">Results History</h2>
                    <ul id="results-list" class="space-y-4">
                        <!-- Results will be dynamically added here -->
                    </ul>
                    <button id="close-history-modal" class="btn btn-primary w-full mt-4">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">Test Results</h2>
            <p id="modal-time" class="text-gray-700 mb-2">‚è± Time: 0.00 seconds</p>
            <p id="modal-failures" class="text-gray-700 mb-2">‚ùå Failures: 0</p>
            <p id="modal-feedback" class="text-blue-600 italic mb-4">Feedback goes here</p>
            <button id="close-modal" class="btn btn-primary w-full">Close</button>
        </div>
    </div>

    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const infoIcon = document.getElementById('info-icon');
        const infoPopup = document.getElementById('info-popup');
        const closePopup = document.getElementById('close-popup');
        const trailTest = document.getElementById('trail-test');
        const resultsList = document.getElementById('results-list');
        const trailContainer = document.getElementById('trail-container');
        const trailResult = document.getElementById('trail-result');
        const timerDisplay = document.getElementById('timer-display');
        const nextNodeDisplay = document.createElement('p');
        nextNodeDisplay.id = 'next-node-display';
        nextNodeDisplay.className = 'ml-4 text-yellow-600 font-bold hidden';
        nextNodeDisplay.textContent = 'Next: ';
        document.querySelector('.navbar .flex').appendChild(nextNodeDisplay);

        const initialDescription = document.getElementById('initial-description');

        function updateDescription(variant) {
            if (variant === 'A') {
                initialDescription.textContent = 'Variant A: Click the numbers in ascending order as quickly as possible.';
            } else if (variant === 'B') {
                initialDescription.textContent = 'Variant B: Alternate between numbers and letters in ascending order (e.g., 1, A, 2, B).';
            }
        }

        document.getElementById('variant-a').addEventListener('click', () => {
            updateDescription('A');
        });

        document.getElementById('variant-b').addEventListener('click', () => {
            updateDescription('B');
        });

        // Move the timer display after the next value clue
        document.querySelector('.navbar .flex').appendChild(timerDisplay);

        const nextValueToggle = document.getElementById('next-value-toggle');
        let showNextValue = JSON.parse(localStorage.getItem('showNextValue')) ?? true;

        let currentNumber = 1;
        let totalCircles = 0;
        let startTime;
        let timerInterval;
        let failureCount = 0; // Track the number of failures

        // Toggle sidebar open/close
        function toggleSidebar() {
            const isSidebarOpen = sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0', !isSidebarOpen);
            document.body.style.overflow = isSidebarOpen ? 'auto' : 'hidden'; // Prevent scrolling when open
        }

        // Close the sidebar
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Open the sidebar
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        // Add event listener for menu toggle button
        menuToggle.addEventListener('click', toggleSidebar);

        // Close the sidebar when clicking outside
        document.addEventListener('click', (event) => {
            if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                closeSidebar();
            }
        });

        // Close the sidebar when clicking a menu link
        document.querySelectorAll('#sidebar button').forEach((button) => {
            button.addEventListener('click', closeSidebar);
        });

        // Info Popup Logic
        infoIcon.addEventListener('click', () => {
            infoPopup.classList.toggle('hidden');
        });

        closePopup.addEventListener('click', () => {
            infoPopup.classList.add('hidden');
        });


        const deleteAllHistoryButton = document.getElementById('delete-all-history');

        deleteAllHistoryButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all history? This action cannot be undone.')) {
                localStorage.removeItem('resultsHistory');
                renderResultsHistory(); // Refresh the history page
            }
        });

        function renderResultsHistory() {
            resultsList.innerHTML = '';
            const results = JSON.parse(localStorage.getItem('resultsHistory')) || [];
            if (results.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'üì≠ No results available.';
                emptyMessage.className = 'text-gray-500';
                resultsList.appendChild(emptyMessage);
                return;
            }

            // Sort results by date in descending order
            results.sort((a, b) => new Date(b.date) - new Date(a.date));

            results.forEach((result, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'p-2 bg-white shadow rounded border border-gray-200 flex justify-between items-center max-w-full overflow-hidden';

                const details = document.createElement('div');
                details.className = 'text-sm';

                const variant = document.createElement('p');
                variant.textContent = `üß™ Variant: ${result.variant}`;
                variant.className = 'text-gray-700 font-bold';

                const timeTaken = document.createElement('p');
                timeTaken.textContent = `‚è± Time: ${result.timeTaken} seconds`;
                timeTaken.className = 'text-gray-600';

                const failures = document.createElement('p');
                failures.textContent = `‚ùå Failures: ${result.failures || 0}`;
                failures.className = result.failures > 0 ? 'text-red-500' : 'text-green-500';

                const feedback = document.createElement('p');
                feedback.textContent = getPerformanceFeedback(result.timeTaken, result.failures, result.variant);
                feedback.className = 'text-blue-600 italic';

                const date = document.createElement('p');
                date.textContent = `üìÖ Date: ${result.date}`;
                date.className = 'text-gray-500 text-xs';

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'üóë Delete';
                deleteButton.className = 'text-red-500 hover:text-red-700 text-sm pt-3 border-t';
                deleteButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this history item?')) {
                        results.splice(index, 1);
                        localStorage.setItem('resultsHistory', JSON.stringify(results));
                        renderResultsHistory(); // Refresh the history page
                    }
                });

                details.appendChild(variant);
                details.appendChild(timeTaken);
                details.appendChild(failures);
                details.appendChild(feedback);
                details.appendChild(date);
                details.appendChild(deleteButton);



                listItem.appendChild(details);

                resultsList.appendChild(listItem);
            });
        }

        function getPerformanceFeedback(timeTaken, failures, variant) {
            if (variant === 'A') {
                if (timeTaken < 30) {
                    return 'üåü Above Average Performance!';
                } else if (timeTaken >= 30 && timeTaken <= 50) {
                    return 'üëç Average Performance.';
                } else {
                    return 'üìâ Below Average Performance.';
                }
            } else if (variant === 'B') {
                if (timeTaken < 75) {
                    return 'üåü Above Average Performance!';
                } else if (timeTaken >= 75 && timeTaken <= 100) {
                    return 'üëç Average Performance.';
                } else {
                    return 'üìâ Below Average Performance.';
                }
            }
            return '‚ùì Invalid variant.';
        }

        function updateNextValuePreference() {
            showNextValue = !showNextValue;
            localStorage.setItem('showNextValue', JSON.stringify(showNextValue));
            nextValueToggle.textContent = `Show Next Value: ${showNextValue ? 'On' : 'Off'}`;
            if (!showNextValue) {
                nextNodeDisplay.classList.add('hidden');
            } else {
                updateNextNodeDisplay();
            }
        }

        nextValueToggle.addEventListener('click', updateNextValuePreference);

        // Trail Making Test Script
        function resetTestState() {
            // Clear the trail container and reset variables
            trailContainer.innerHTML = '';
            timerDisplay.classList.add('hidden');
            nextNodeDisplay.classList.add('hidden');
            currentNumber = 1;
            failureCount = 0;
            clearInterval(timerInterval); // Stop any running timer
        }

        function generateCircles(variant) {
            resetTestState(); // Ensure the test state is reset before generating new circles

            let timerStarted = false; // Track if the timer has started
            const items = [];
            if (variant === 'A') {
                totalCircles = 25;
                for (let i = 1; i <= totalCircles; i++) {
                    items.push(i.toString());
                }
            } else if (variant === 'B') {
                totalCircles = 26; // Adjust total circles for alternating numbers and letters
                for (let i = 1; i <= totalCircles / 2; i++) {
                    items.push(i.toString());
                    items.push(String.fromCharCode(64 + i)); // A, B, C...
                }
            }

            const containerRect = trailContainer.getBoundingClientRect();
            const nodeSize = calculateNodeSize(); // Dynamically calculate node size
            const positions = [];
            items.forEach((item, index) => {
                let top, left;
                let overlap;
                do {
                    overlap = false;
                    top = Math.random() * (containerRect.height - nodeSize); // Avoid edges
                    left = Math.random() * (containerRect.width - nodeSize); // Avoid edges
                    for (const pos of positions) {
                        const distance = Math.sqrt(
                            Math.pow(pos.top - top, 2) + Math.pow(pos.left - left, 2)
                        );
                        if (distance < nodeSize) { // Minimum distance between circles
                            overlap = true;
                            break;
                        }
                    }
                } while (overlap);

                positions.push({ top, left });

                const circle = document.createElement('div');
                circle.textContent = item;
                circle.className = 'absolute border border-black flex items-center justify-center rounded-full cursor-pointer';
                circle.style.width = `${nodeSize}px`;
                circle.style.height = `${nodeSize}px`;
                circle.style.top = `${top}px`;
                circle.style.left = `${left}px`;
                circle.dataset.order = index + 1;

                circle.addEventListener('click', () => {
                    if (!timerStarted) {
                        startTimer(); // Start the timer on the first click
                        timerStarted = true;
                    }
                    if (parseInt(circle.dataset.order) === currentNumber) {
                        circle.classList.add('bg-green-500');
                        resetErrorNodes(); // Reset any error nodes
                        currentNumber++;
                        if (showNextValue) {
                            updateNextNodeDisplay(); // Update the next node display
                        }
                        if (currentNumber > totalCircles) {
                            stopTimer();
                            const timeTaken = ((new Date() - startTime) / 1000).toFixed(2);
                            saveResultToLocalStorage(variant, timeTaken, failureCount);
                            showResultsModal(timeTaken, failureCount, variant); // Show modal with results
                        }
                    } else {
                        circle.classList.add('bg-red-300'); // Highlight incorrect node
                        failureCount++;
                    }
                });

                trailContainer.appendChild(circle);
            });

            if (variant === 'B' && showNextValue) {
                updateNextNodeDisplay(); // Display the first node for Variant B
            }
        }

        function updateNextNodeDisplay() {
            const nextNode = document.querySelector(`[data-order="${currentNumber}"]`);
            if (nextNode) {
                nextNodeDisplay.textContent = `Next: ${nextNode.textContent}`;
                nextNodeDisplay.classList.remove('hidden');
            } else {
                nextNodeDisplay.classList.add('hidden');
            }
        }

        function calculateNodeSize() {
            const screenWidth = window.innerWidth;
            if (screenWidth >= 1024) {
                return 74; // Larger size for desktop screens
            } else if (screenWidth >= 768) {
                return 56; // Medium size for tablets
            } else {
                return 60; // Default size for smaller screens
            }
        }

        function startTimer() {
            startTime = new Date();
            timerDisplay.textContent = `‚è± 0 seconds`; // Display timer immediately
            timerDisplay.classList.remove('hidden'); // Ensure the timer is visible from the start
            timerInterval = setInterval(() => {
                const elapsedTime = Math.floor((new Date() - startTime) / 1000); // Display only seconds
                timerDisplay.textContent = `‚è± ${elapsedTime} seconds`;
            }, 1000); // Update every second
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplay.classList.add('hidden'); // Hide the timer after the test is completed
        }

        function resetErrorNodes() {
            const errorNodes = document.querySelectorAll('.bg-red-300');
            errorNodes.forEach(node => {
                node.classList.remove('bg-red-300');
            });
        }

        function saveResultToLocalStorage(variant, timeTaken, failures) {
            const results = JSON.parse(localStorage.getItem('resultsHistory')) || [];
            results.push({ variant, timeTaken, failures, date: new Date().toLocaleString() });
            localStorage.setItem('resultsHistory', JSON.stringify(results));
        }

        // Add event listeners for Variant A and Variant B buttons
        let currentVariant = 'A'; // Track the current variant
        document.getElementById('variant-a').addEventListener('click', () => {
            currentVariant = 'A';
            generateCircles('A');
        });
        document.getElementById('variant-b').addEventListener('click', () => {
            currentVariant = 'B';
            generateCircles('B');
        });

        // Initialize the toggle button state
        nextValueToggle.textContent = `Show Next Value: ${showNextValue ? 'On' : 'Off'}`;

        const resultsModal = document.getElementById('results-modal');
        const modalTime = document.getElementById('modal-time');
        const modalFailures = document.getElementById('modal-failures');
        const modalFeedback = document.getElementById('modal-feedback');
        const closeModal = document.getElementById('close-modal');

        let lastTestResults = null; // Store the last test results

        closeModal.addEventListener('click', () => {
            resultsModal.classList.add('hidden');
            if (lastTestResults) {
                reopenModalButton.classList.remove('hidden');
            }
        });

        // Add a button to reopen the modal
        const reopenModalButton = document.createElement('button');
        reopenModalButton.id = 'reopen-modal';
        reopenModalButton.className = 'btn btn-secondary mt-4';
        reopenModalButton.textContent = 'Reopen Last Results';
        reopenModalButton.addEventListener('click', reopenResultsModal);
        document.querySelector('.navbar').appendChild(reopenModalButton);

        function showResultsModal(timeTaken, failures, variant) {
            modalTime.textContent = `‚è± Time: ${timeTaken} seconds`;
            modalFailures.textContent = `‚ùå Failures: ${failures}`;
            modalFeedback.textContent = getPerformanceFeedback(timeTaken, failures, variant);
            resultsModal.classList.remove('hidden');
            lastTestResults = { timeTaken, failures, variant }; // Save the last test results
        }

        function reopenResultsModal() {
            if (lastTestResults) {
                const { timeTaken, failures, variant } = lastTestResults;
                showResultsModal(timeTaken, failures, variant);
            }
        }

        // Hide the reopen button when a new test starts
        function resetTest() {
            lastTestResults = null;
            resultsModal.classList.add('hidden');
            reopenModalButton.classList.add('hidden');
        }

        // Show the reopen button when results are available
        closeModal.addEventListener('click', () => {
            resultsModal.classList.add('hidden');
            if (lastTestResults) {
                reopenModalButton.classList.remove('hidden');
            }
        });

        // Ensure the reopen button is hidden when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            reopenModalButton.classList.add('hidden');
        });

        // Ensure proper visibility toggling between sections
        function showTrailTest() {
            trailTest.classList.remove('hidden');
        }

        function showResultsHistory() {
            trailTest.classList.add('hidden');
        }

        document.querySelectorAll('#variant-a, #variant-b').forEach(button => {
            button.addEventListener('click', () => {
                showTrailTest();
                const variant = button.id === 'variant-a' ? 'A' : 'B';
                generateCircles(variant);
            });
        });

        const resultsHistoryModal = document.getElementById('results-history-modal');
        const closeHistoryModalButton = document.getElementById('close-history-modal');

        // Show the Results History Modal when pressing "H"
        document.addEventListener('keydown', (event) => {
            if (event.key.toLowerCase() === 'h' || event.key === 'H') {
                console.debug('Key "H" pressed: Opening Results History Modal');
                renderResultsHistory();
                resultsHistoryModal.classList.remove('hidden');
            }
        });

        document.getElementById('results-history').addEventListener('click', () => {
            console.debug('Results History button clicked: Opening Results History Modal');
            renderResultsHistory();
            resultsHistoryModal.classList.remove('hidden');
        });

        // Close the Results History Modal
        closeHistoryModalButton.addEventListener('click', () => {
            console.debug('Closing Results History Modal');
            resultsHistoryModal.classList.add('hidden');
        });

        // Close the Results History Modal when pressing "Escape"
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !resultsHistoryModal.classList.contains('hidden')) {
                console.debug('Key "Escape" pressed: Closing Results History Modal');
                resultsHistoryModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
