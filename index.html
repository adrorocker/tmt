<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive Trail Making Test (TMT-A & TMT-B) to measure processing speed, attention, and task-switching. Test your cognitive skills online!">
    <meta property="og:description" content="Interactive Trail Making Test (TMT-A & TMT-B) to measure processing speed, attention, and task-switching. Test your cognitive skills online!">
    <title>Trail Making Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="layout" class="flex h-screen transition-transform duration-300">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed bg-gray-200 top-0 left-0 w-64 h-full transform transition-transform duration-300 -translate-x-full z-20">
            <div class="p-4 flex flex-col h-full">
                <!-- Logo -->
                <div class="flex items-center justify-center">
                    <span class="text-xl font-bold text-blue-500">Trail Making Test</span>
                </div>
                <!-- Main Menu -->
                <ul class="mt-4">
                    <li class="py-2"><button id="variant-a" class="hover:text-blue-500">Variant A</button></li>
                    <li class="py-2"><button id="variant-b" class="hover:text-blue-500">Variant B</button></li>
                    <li class="py-2"><button id="results-history" class="hover:text-blue-500">Results History</button></li>
                </ul>
                <div class="flex-grow"></div>
                <!-- Settings Section -->
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-600 mb-2">Settings</h3>
                    <button id="delete-all-history" class="hover:text-red-500 text-sm">Delete All History</button>
                    <button id="next-value-toggle" class="hover:text-red-500 text-sm">Show Next Value: On</button>
                    <button id="feedback-toggle" class="hover:text-blue-500 text-sm">Color Feedback: On</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 transform transition-transform duration-300">
            <!-- Navbar -->
            <div class="navbar flex justify-between items-center p-4 z-50">
                <div class="flex items-center">
                    <button id="menu-toggle" class="btn btn-square btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <p id="timer-display" class="ml-4 text-blue-600 font-bold hidden">Time: 0 seconds</p>
                    <p id="trail-result" class="mt-4 text-green-600 font-bold hidden">Test completed successfully!</p>
                </div>
                <div class="flex items-center justify-end space-x-4">
                    <button id="open-averages" class="text-blue-500 hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M9 17l3-3 5 5M9 7l3 3 5-5" />
                        </svg>
                    </button>
                    <button id="open-results-history" class="text-blue-500 hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-4-4H5a2 2 0 00-2 2v4h16V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                    <button id="info-icon" class="text-blue-500 hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                        </svg>
                    </button>
                    <a href="https://github.com/adrorocker/tmt" target="_blank" class="text-blue-500 hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.483 0-.237-.009-.868-.013-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.154-1.11-1.461-1.11-1.461-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.983 1.03-2.682-.103-.253-.447-1.27.098-2.645 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.845c.85.004 1.705.115 2.504.337 1.91-1.296 2.75-1.026 2.75-1.026.545 1.375.2 2.392.098 2.645.64.699 1.03 1.591 1.03 2.682 0 3.841-2.338 4.687-4.566 4.935.36.31.682.92.682 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.579.688.481C19.138 20.164 22 16.418 22 12c0-5.523-4.477-10-10-10z" />
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Page Content -->
            <div id="trail-test" class="p-4">
                <div id="info-popup" class="hidden absolute top-16 right-4 bg-white border border-gray-300 shadow-lg p-4 rounded w-64 z-10">
                    <p class="text-sm text-gray-700">Click the circles in the correct order as quickly as possible. Variant A uses numbers, and Variant B alternates between numbers and letters.</p>
                    <button id="close-popup" class="mt-2 text-blue-500 hover:text-blue-400">Close</button>
                </div>
                <div id="trail-container" class="relative w-full h-[calc(100vh-8rem)] mt-4">
                    <!-- Circles will be generated here -->
                    <div id="initial-description" class="flex flex-col items-center mt-8 space-y-6">
                        <p class="text-center text-lg text-gray-700">
                            Welcome to the <span class="text-blue-600 font-bold">Trail Making Test</span>! <br>
                            <span id="choose-variant-intro" class="text-gray-600">
                                Choose a variant to start and test your skills.
                            </span>
                        </p>
                        <div class="flex space-x-4">
                            <button id="start-variant-a" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300">
                                Start Variant A
                            </button>
                            <button id="start-variant-b" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300">
                                Start Variant B
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results History Modal -->
            <div id="results-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden absolute z-50">
                <div class="bg-white p-6 rounded shadow-lg w-96 max-h-[80vh] overflow-y-auto relative">
                    <h2 class="text-xl font-bold mb-4">Results History</h2>
                    <ul id="results-list" class="space-y-4">
                        <!-- Results will be dynamically added here -->
                    </ul>
                    <button id="close-history-modal" class="btn btn-primary w-full mt-5 sticky p-2 bg-blue-500 text-white rounded left-4 right-4 bottom-0">
                        Close
                    </button>
                </div>
            </div>

            <!-- Averages Modal -->
            <div id="averages-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white p-6 rounded shadow-lg w-96">
                    <h2 class="text-xl font-bold mb-4 text-center">📊 Average Times</h2>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">🧪</span>
                            <p id="average-tmt-a" class="text-gray-700 text-lg">TMT-A: N/A</p>
                            <span id="average-tmt-a-icon" class="text-2xl"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">🔄</span>
                            <p id="average-tmt-b" class="text-gray-700 text-lg">TMT-B: N/A</p>
                            <span id="average-tmt-b-icon" class="text-2xl"></span>
                        </div>
                    </div>
                    <button id="close-averages-modal" class="btn btn-primary w-full mt-6 bg-blue-500 text-white rounded-lg py-2 hover:bg-blue-600">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">Test Results</h2>
            <p id="modal-time" class="text-gray-700 mb-2">⏱ Time: 0.00 seconds</p>
            <p id="modal-failures" class="text-gray-700 mb-2">❌ Failures: 0</p>
            <p id="modal-feedback" class="text-blue-600 italic mb-4">Feedback goes here</p>
            <button id="close-modal" class="btn btn-primary w-full">Close</button>
        </div>
    </div>

    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const infoIcon = document.getElementById('info-icon');
        const infoPopup = document.getElementById('info-popup');
        const closePopup = document.getElementById('close-popup');
        const trailTest = document.getElementById('trail-test');
        const resultsList = document.getElementById('results-list');
        const trailContainer = document.getElementById('trail-container');
        const trailResult = document.getElementById('trail-result');
        const timerDisplay = document.getElementById('timer-display');
        const nextNodeDisplay = document.createElement('p');
        nextNodeDisplay.id = 'next-node-display';
        nextNodeDisplay.className = 'ml-4 text-yellow-600 font-bold hidden';
        nextNodeDisplay.textContent = 'Next: ';
        document.querySelector('.navbar .flex').appendChild(nextNodeDisplay);

        const initialDescription = document.getElementById('initial-description');

        function updateDescription(variant) {
            if (variant === 'A') {
                initialDescription.textContent = 'Variant A: Click the numbers in ascending order as quickly as possible.';
            } else if (variant === 'B') {
                initialDescription.textContent = 'Variant B: Alternate between numbers and letters in ascending order (e.g., 1, A, 2, B).';
            }
        }

        document.getElementById('variant-a').addEventListener('click', () => {
            updateDescription('A');
        });

        document.getElementById('variant-b').addEventListener('click', () => {
            updateDescription('B');
        });

        // Move the timer display after the next value clue
        document.querySelector('.navbar .flex').appendChild(timerDisplay);

        const nextValueToggle = document.getElementById('next-value-toggle');
        let showNextValue = JSON.parse(localStorage.getItem('showNextValue')) ?? true;

        let currentNumber = 1;
        let totalCircles = 0;
        let startTime;
        let timerInterval;
        let failureCount = 0; // Track the number of failures

        let colorChangingFeedback = JSON.parse(localStorage.getItem('colorChangingFeedback')) ?? false; // Default to false

        // Toggle sidebar open/close
        function toggleSidebar() {
            const isSidebarOpen = sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0', !isSidebarOpen);
            document.body.style.overflow = isSidebarOpen ? 'auto' : 'hidden'; // Prevent scrolling when open
        }

        // Close the sidebar
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Open the sidebar
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        // Add event listener for menu toggle button
        menuToggle.addEventListener('click', toggleSidebar);

        // Close the sidebar when clicking outside
        document.addEventListener('click', (event) => {
            if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                closeSidebar();
            }
        });

        // Close the sidebar when clicking a menu link
        document.querySelectorAll('#sidebar button').forEach((button) => {
            button.addEventListener('click', closeSidebar);
        });

        // Info Popup Logic
        infoIcon.addEventListener('click', () => {
            infoPopup.classList.toggle('hidden');
        });

        closePopup.addEventListener('click', () => {
            infoPopup.classList.add('hidden');
        });


        const deleteAllHistoryButton = document.getElementById('delete-all-history');

        deleteAllHistoryButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all history? This action cannot be undone.')) {
                localStorage.removeItem('resultsHistory');
                renderResultsHistory(); // Refresh the history page
            }
        });

        function renderResultsHistory() {
            resultsList.innerHTML = '';
            const results = JSON.parse(localStorage.getItem('resultsHistory')) || [];
            if (results.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = '📭 No results available.';
                emptyMessage.className = 'text-gray-500';
                resultsList.appendChild(emptyMessage);
                return;
            }

            // Sort results by date in descending order
            results.sort((a, b) => new Date(b.date) - new Date(a.date));

            results.forEach((result, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'p-2 bg-white shadow rounded border border-gray-200 flex justify-between items-center max-w-full overflow-hidden';

                const details = document.createElement('div');
                details.className = 'text-sm';

                const variant = document.createElement('p');
                variant.textContent = `🧪 Variant: ${result.variant}`;
                variant.className = 'text-gray-700 font-bold';

                const timeTaken = document.createElement('p');
                timeTaken.textContent = `⏱ Time: ${result.timeTaken} seconds`;
                timeTaken.className = 'text-gray-600';

                const failures = document.createElement('p');
                failures.textContent = `❌ Failures: ${result.failures || 0}`;
                failures.className = result.failures > 0 ? 'text-red-500' : 'text-green-500';

                const feedback = document.createElement('p');
                feedback.textContent = getPerformanceFeedback(result.timeTaken, result.failures, result.variant);
                feedback.className = 'text-blue-600 italic';

                const date = document.createElement('p');
                date.textContent = `📅 Date: ${result.date}`;
                date.className = 'text-gray-500 text-xs';

                const deleteButton = document.createElement('button');
                deleteButton.textContent = '🗑 Delete';
                deleteButton.className = 'text-red-500 hover:text-red-700 text-sm pt-3 border-t';
                deleteButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this history item?')) {
                        results.splice(index, 1);
                        localStorage.setItem('resultsHistory', JSON.stringify(results));
                        renderResultsHistory(); // Refresh the history page
                    }
                });

                details.appendChild(variant);
                details.appendChild(timeTaken);
                details.appendChild(failures);
                details.appendChild(feedback);
                details.appendChild(date);
                details.appendChild(deleteButton);



                listItem.appendChild(details);

                resultsList.appendChild(listItem);
            });
        }

        function getPerformanceFeedback(timeTaken, failures, variant) {
            if (variant === 'A') {
                if (timeTaken < 30) {
                    return '🌟 Above Average Performance!';
                } else if (timeTaken >= 30 && timeTaken <= 77) {
                    return '👍 Average Performance.';
                } else {
                    return '📉 Deficient Performance.';
                }
            } else if (variant === 'B') {
                if (timeTaken <= 75) {
                    return '🌟 Above Average Performance!';
                } else if (timeTaken > 75 && timeTaken <= 273) {
                    return '👍 Average Performance.';
                } else {
                    return '📉 Deficient Performance.';
                }
            }
            return '❓ Invalid variant.';
        }

        function updateNextValuePreference() {
            showNextValue = !showNextValue;
            localStorage.setItem('showNextValue', JSON.stringify(showNextValue));
            nextValueToggle.textContent = `Show Next Value: ${showNextValue ? 'On' : 'Off'}`;
            if (!showNextValue) {
                nextNodeDisplay.classList.add('hidden');
            } else {
                updateNextNodeDisplay();
            }
        }

        nextValueToggle.addEventListener('click', updateNextValuePreference);

        // Toggle color-changing feedback
        function toggleColorChangingFeedback() {
            colorChangingFeedback = !colorChangingFeedback;
            localStorage.setItem('colorChangingFeedback', JSON.stringify(colorChangingFeedback));
            feedbackToggle.textContent = `Color Feedback: ${colorChangingFeedback ? 'On' : 'Off'}`;
        }

        // Add a toggle button for color-changing feedback in the settings section
        const feedbackToggle = document.getElementById('feedback-toggle');
        feedbackToggle.addEventListener('click', toggleColorChangingFeedback);

        // Trail Making Test Script
        function resetTestState() {
            // Clear the trail container and reset variables
            trailContainer.innerHTML = '';
            timerDisplay.classList.add('hidden');
            nextNodeDisplay.classList.add('hidden');
            currentNumber = 1;
            failureCount = 0;
            clearInterval(timerInterval); // Stop any running timer
        }

        function generateCircles(variant) {
            resetTestState(); // Ensure the test state is reset before generating new circles

            let timerStarted = false; // Track if the timer has started
            const items = [];
            if (variant === 'A') {
                totalCircles = 25;
                for (let i = 1; i <= totalCircles; i++) {
                    items.push(i.toString());
                }
            } else if (variant === 'B') {
                totalCircles = 25; // Adjust total circles for alternating numbers and letters
                for (let i = 1; i <= totalCircles / 2; i++) {
                    items.push(i.toString());
                    items.push(String.fromCharCode(64 + i)); // A, B, C...
                }
            }

            const containerRect = trailContainer.getBoundingClientRect();
            const nodeSize = calculateNodeSize(); // Dynamically calculate node size
            const positions = [];
            items.forEach((item, index) => {
                let top, left;
                let overlap;
                do {
                    overlap = false;
                    top = Math.random() * (containerRect.height - nodeSize); // Avoid edges
                    left = Math.random() * (containerRect.width - nodeSize); // Avoid edges
                    for (const pos of positions) {
                        const distance = Math.sqrt(
                            Math.pow(pos.top - top, 2) + Math.pow(pos.left - left, 2)
                        );
                        if (distance < nodeSize) { // Minimum distance between circles
                            overlap = true;
                            break;
                        }
                    }
                } while (overlap);

                positions.push({ top, left });

                const circle = document.createElement('div');
                circle.textContent = item;
                circle.className = 'absolute border border-black flex items-center justify-center rounded-full cursor-pointer';
                circle.style.width = `${nodeSize}px`;
                circle.style.height = `${nodeSize}px`;
                circle.style.top = `${top}px`;
                circle.style.left = `${left}px`;
                circle.dataset.order = index + 1;

                // Set font size based on screen width
                circle.style.fontSize = '20px'; // Default font size
                if (window.innerWidth >= 1024) {
                    circle.style.fontSize = '25px'; // Larger font size for desktop screens
                } else if (window.innerWidth >= 768) {
                    circle.style.fontSize = '23px'; // Medium font size for tablets
                }

                circle.addEventListener('click', () => {
                    if (!timerStarted) {
                        startTimer(); // Start the timer on the first click
                        timerStarted = true;
                    }
                    if (parseInt(circle.dataset.order) === currentNumber) {
                        if (colorChangingFeedback) {
                            circle.classList.add('bg-green-500'); // Correct node with color feedback
                        }
                        resetErrorNodes(); // Reset any error nodes
                        if (currentNumber === totalCircles) {
                            circle.textContent += '!'; // Add "!" to the last node
                        }
                        currentNumber++;
                        if (showNextValue) {
                            updateNextNodeDisplay(); // Update the next node display
                        }
                        if (currentNumber > totalCircles) {
                            stopTimer();
                            const timeTaken = ((new Date() - startTime) / 1000).toFixed(2);
                            saveResultToLocalStorage(variant, timeTaken, failureCount);
                            showResultsModal(timeTaken, failureCount, variant); // Show modal with results
                        }
                    } else {
                        circle.classList.add('bg-red-300'); // Incorrect node
                    }
                });

                trailContainer.appendChild(circle);
            });

            if (variant === 'B' && showNextValue) {
                updateNextNodeDisplay(); // Display the first node for Variant B
            }
        }

        function updateNextNodeDisplay() {
            const nextNode = document.querySelector(`[data-order="${currentNumber}"]`);
            if (nextNode) {
                nextNodeDisplay.textContent = `Next: ${nextNode.textContent}`;
                nextNodeDisplay.classList.remove('hidden');
            } else {
                nextNodeDisplay.classList.add('hidden');
            }
        }

        function calculateNodeSize() {
            const screenWidth = window.innerWidth;
            if (screenWidth >= 1024) {
                return 74; // Larger size for desktop screens
            } else if (screenWidth >= 768) {
                return 56; // Medium size for tablets
            } else {
                return 40; // Smaller size for smaller screens
            }
        }

        function startTimer() {
            startTime = new Date();
            timerDisplay.textContent = `⏱ 0 seconds`; // Display timer immediately
            timerDisplay.classList.remove('hidden'); // Ensure the timer is visible from the start
            timerInterval = setInterval(() => {
                const elapsedTime = Math.floor((new Date() - startTime) / 1000); // Display only seconds
                timerDisplay.textContent = `⏱ ${elapsedTime} seconds`;
            }, 1000); // Update every second
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplay.classList.add('hidden'); // Hide the timer after the test is completed
        }

        function resetErrorNodes() {
            const errorNodes = document.querySelectorAll('.bg-red-300');
            errorNodes.forEach(node => {
                node.classList.remove('bg-red-300');
            });
        }

        function saveResultToLocalStorage(variant, timeTaken, failures) {
            const results = JSON.parse(localStorage.getItem('resultsHistory')) || [];
            results.push({ variant, timeTaken, failures, date: new Date().toLocaleString() });
            localStorage.setItem('resultsHistory', JSON.stringify(results));
        }

        // Add event listeners for Variant A and Variant B buttons
        let currentVariant = 'A'; // Track the current variant
        document.getElementById('variant-a').addEventListener('click', () => {
            currentVariant = 'A';
            generateCircles('A');
        });
        document.getElementById('variant-b').addEventListener('click', () => {
            currentVariant = 'B';
            generateCircles('B');
        });

        // Initialize the toggle button state
        nextValueToggle.textContent = `Show Next Value: ${showNextValue ? 'On' : 'Off'}`;

        const resultsModal = document.getElementById('results-modal');
        const modalTime = document.getElementById('modal-time');
        const modalFailures = document.getElementById('modal-failures');
        const modalFeedback = document.getElementById('modal-feedback');
        const closeModal = document.getElementById('close-modal');

        let lastTestResults = null; // Store the last test results

        closeModal.addEventListener('click', () => {
            resultsModal.classList.add('hidden');
            if (currentVariant) {
                currentNumber = 1; // Reset the current next number
                nextNodeDisplay.textContent = 'Next: '; // Reset the next value display
                generateCircles(currentVariant); // Reset the same variant test
            }
        });


        function showResultsModal(timeTaken, failures, variant) {
            modalTime.textContent = `⏱ Time: ${timeTaken} seconds`;
            modalFailures.textContent = `❌ Failures: ${failures}`;
            modalFeedback.textContent = getPerformanceFeedback(timeTaken, failures, variant);
            resultsModal.classList.remove('hidden');
            lastTestResults = { timeTaken, failures, variant }; // Save the last test results
        }

        function reopenResultsModal() {
            if (lastTestResults) {
                const { timeTaken, failures, variant } = lastTestResults;
                showResultsModal(timeTaken, failures, variant);
            }
        }

        // Hide the reopen button when a new test starts
        function resetTest() {
            lastTestResults = null;
            resultsModal.classList.add('hidden');
        }

        // Show the reopen button when results are available
        closeModal.addEventListener('click', () => {
            resultsModal.classList.add('hidden');
        });

        // Ensure the reopen button is hidden when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize color-changing feedback state from localStorage
            colorChangingFeedback = JSON.parse(localStorage.getItem('colorChangingFeedback')) ?? false; // Default to false
            feedbackToggle.textContent = `Color Feedback: ${colorChangingFeedback ? 'On' : 'Off'}`;
        });

        // Ensure proper visibility toggling between sections
        function showTrailTest() {
            trailTest.classList.remove('hidden');
        }

        function showResultsHistory() {
            trailTest.classList.add('hidden');
        }

        document.querySelectorAll('#variant-a, #variant-b').forEach(button => {
            button.addEventListener('click', () => {
                showTrailTest();
                const variant = button.id === 'variant-a' ? 'A' : 'B';
                generateCircles(variant);
            });
        });

        const resultsHistoryModal = document.getElementById('results-history-modal');
        const closeHistoryModalButton = document.getElementById('close-history-modal');

        // Show the Results History Modal when pressing "H"
        document.addEventListener('keydown', (event) => {
            if (event.key.toLowerCase() === 'h' || event.key === 'H') {
                console.debug('Key "H" pressed: Opening Results History Modal');
                renderResultsHistory();
                resultsHistoryModal.classList.remove('hidden');
            }
        });

        document.getElementById('results-history').addEventListener('click', () => {
            console.debug('Results History button clicked: Opening Results History Modal');
            renderResultsHistory();
            resultsHistoryModal.classList.remove('hidden');
        });

        // Close the Results History Modal
        closeHistoryModalButton.addEventListener('click', () => {
            console.debug('Closing Results History Modal');
            resultsHistoryModal.classList.add('hidden');
        });

        // Close the Results History Modal when pressing "Escape"
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !resultsHistoryModal.classList.contains('hidden')) {
                console.debug('Key "Escape" pressed: Closing Results History Modal');
                resultsHistoryModal.classList.add('hidden');
            }
        });

        document.getElementById('start-variant-a').addEventListener('click', () => {
            currentVariant = 'A';
            generateCircles('A');
        });

        document.getElementById('start-variant-b').addEventListener('click', () => {
            currentVariant = 'B';
            generateCircles('B');
        });

        document.getElementById('open-results-history').addEventListener('click', () => {
            renderResultsHistory(); // Populate the results history
            document.getElementById('results-history-modal').classList.remove('hidden'); // Show the modal
        });

        document.getElementById('open-averages').addEventListener('click', () => {
            const results = JSON.parse(localStorage.getItem('resultsHistory')) || [];
            const tmtAResults = results.filter(result => result.variant === 'A');
            const tmtBResults = results.filter(result => result.variant === 'B');

            const averageA = tmtAResults.length
                ? (tmtAResults.reduce((sum, result) => sum + parseFloat(result.timeTaken), 0) / tmtAResults.length).toFixed(2)
                : 'N/A';
            const averageB = tmtBResults.length
                ? (tmtBResults.reduce((sum, result) => sum + parseFloat(result.timeTaken), 0) / tmtBResults.length).toFixed(2)
                : 'N/A';

            document.getElementById('average-tmt-a').textContent = `TMT-A: ${averageA} seconds`;
            document.getElementById('average-tmt-b').textContent = `TMT-B: ${averageB} seconds`;

            const averageAIcon = document.getElementById('average-tmt-a-icon');
            const averageBIcon = document.getElementById('average-tmt-b-icon');

            // Set icons based on performance interpretation
            averageAIcon.textContent = averageA !== 'N/A' && averageA < 30 ? '🌟' : averageA <= 50 ? '👍' : '📉';
            averageBIcon.textContent = averageB !== 'N/A' && averageB < 75 ? '🌟' : averageB <= 100 ? '👍' : '📉';

            document.getElementById('averages-modal').classList.remove('hidden');
        });

        document.getElementById('close-averages-modal').addEventListener('click', () => {
            document.getElementById('averages-modal').classList.add('hidden');
        });
    </script>
</body>
</html>
